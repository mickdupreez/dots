"use strict";!function(){var a=vAPI.localStorage.getItem("popupFontSize");"string"==typeof a&&"unset"!==a&&document.body.style.setProperty("font-size",a);var b="true"===vAPI.localStorage.getItem("popupFirewallPane");/[\?&]fullsize=1/.test(window.location.search)&&document.body.classList.add("fullsize"),/[\?&]mobile=1/.test(window.location.search)&&document.body.classList.add("mobile"),document.getElementById("rulesetTools").style.setProperty("top",document.getElementById("gotoPrefs").getBoundingClientRect().bottom+3+"px");var c=function(){document.getElementById("rulesetTools").style.setProperty("left",document.getElementById("firewallContainer").getBoundingClientRect().left+3+"px")};b&&document.getElementById("panes").classList.add("dfEnabled");var d=vAPI.messaging,e={},f=!1,g=/^\d+(?:\.\d+){1,3}$/,h=/^d[abn]:([^ ]+) ([^ ]+) ([^ ]+)/,i={"/":"*",".":""},j=null,k={},l={},m=0,n=[],o=0,p=uDom(),q="",r=vAPI.i18n("popupBlockedStats"),s=vAPI.i18n("popupHitDomainCount"),t=function(a){if(e={},i["."]="",k={},"object"!=typeof a)return e;e=a,i["."]=e.pageHostname||"";var b=e.hostnameDict;if("object"!=typeof b)return e;var c,d;for(var f in b)b.hasOwnProperty(f)!==!1&&(c=b[f].domain,d=f.slice(0,0-c.length),c===e.pageDomain&&(c=" "),k[f]=c+d.split(".").reverse().join("."));return e},u=function(a){if("behind-the-scene"===e.pageHostname)return void uDom("body").toggleClass("dirty",!1);var b,c=[],d=e.firewallRules;for(var f in d)d.hasOwnProperty(f)!==!1&&(b=d[f],""!==b&&c.push(b));c.sort(),c.push(uDom("body").hasClass("off")),c.push(uDom.nodeFromId("no-large-media").classList.contains("on")),c.push(uDom.nodeFromId("no-cosmetic-filtering").classList.contains("on")),c.push(uDom.nodeFromId("no-remote-fonts").classList.contains("on"));var g=c.join("");a&&(q=g),uDom("body").toggleClass("dirty",g!==q)},v=function(a){return"number"==typeof a?a.toLocaleString():""},w=function(a,b){var c=a.slice(2,a.indexOf(" ",2));g.test(c)||(c=k[c]||" ");var d=b.slice(2,b.indexOf(" ",2));g.test(d)||(d=k[d]||" ");var e=c.charCodeAt(0),f=d.charCodeAt(0);return e!==f?e-f:c.localeCompare(d)},x=function(a){var b=p.pop();0===b.length&&(b=uDom("#templates > div:nth-of-type(1)").clone()),b.descendants("[data-des]").attr("data-des",a),b.descendants("span:nth-of-type(1)").text(punycode.toUnicode(a));var c=e.hostnameDict[a]||{},d=a===c.domain;return b.toggleClass("isDomain",d).toggleClass("isSubDomain",!d).toggleClass("allowed",0!==c.allowCount).toggleClass("blocked",0!==c.blockCount).toggleClass("totalAllowed",0!==c.totalAllowCount).toggleClass("totalBlocked",0!==c.totalBlockCount),b.appendTo("#firewallContainer"),b},y=function(a,b,c,d){var f='#firewallContainer span[data-src="'+a+'"][data-des="'+b+'"][data-type="'+c+'"]',g=uDom(f);if(0!==g.length){g.removeClass();var j=d.charAt(1);""!==j&&g.toggleClass(j+"Rule",!0);var k=!1,l=h.exec(d);if(null!==l&&(k=("*"!==l[2]||l[3]===c)&&l[2]===b&&l[1]===i[a]),g.toggleClass("ownRule",k),"."===a&&"*"!==b){if(e.hostnameDict.hasOwnProperty(b)===!1)return g.removeAttr("data-acount"),void g.removeAttr("data-acount");var m=e.hostnameDict[b],n=g.nodeAt(0);0!==m.allowCount?n.setAttribute("data-acount",Math.min(Math.ceil(Math.log(m.allowCount+1)/Math.LN10),3)):n.removeAttribute("data-acount"),0!==m.blockCount?n.setAttribute("data-bcount",Math.min(Math.ceil(Math.log(m.blockCount+1)/Math.LN10),3)):n.removeAttribute("data-bcount"),m.domain===b&&(n=g.nodeAt(1),0!==m.totalAllowCount?n.setAttribute("data-acount",Math.min(Math.ceil(Math.log(m.totalAllowCount+1)/Math.LN10),3)):n.removeAttribute("data-acount"),0!==m.totalBlockCount?n.setAttribute("data-bcount",Math.min(Math.ceil(Math.log(m.totalBlockCount+1)/Math.LN10),3)):n.removeAttribute("data-bcount"))}}},z=function(){var a=e.firewallRules;for(var b in a)a.hasOwnProperty(b)!==!1&&y(b.charAt(0),b.slice(2,b.indexOf(" ",2)),b.slice(b.lastIndexOf(" ")+1),a[b]);c(),uDom.nodeFromId("firewallContainer").classList.toggle("dirty",e.matrixIsDirty===!0)},A=function(){null===j&&(j=uDom("#actionSelector").toggleClass("colorBlind",e.colorBlindFriendly).on("click","span",O)),j.detach(),p=uDom("#firewallContainer > div:nth-of-type(7) ~ div").detach();for(var a=n.length,b=0;a>b;b++)x(n[b]);f!==!0&&e.advancedUserEnabled&&(uDom("#firewallContainer").on("click","span[data-src]",N).on("mouseenter","[data-src]",K).on("mouseleave","[data-src]",L),f=!0),z()},B=function(){l={},m=o=0,n=[];for(var a,b,c,d={},f=Object.keys(e.firewallRules).sort(w),g=0;g<f.length;g++)a=f[g],b=a.slice(2,a.indexOf(" ",2)),"*"===b||d.hasOwnProperty(b)||(c=e.hostnameDict[b]||{},l.hasOwnProperty(c.domain)===!1&&(l[c.domain]=!1,m+=1),0!==c.allowCount&&l[c.domain]===!1&&(l[c.domain]=!0,o+=1),n.push(b),d[b]=!0);var h=s.replace("{{count}}",o.toLocaleString()).replace("{{total}}",m.toLocaleString());uDom.nodeFromId("popupHitDomainCount").textContent=h},C=function(){e.tabTitle&&(document.title=e.appName+" - "+e.tabTitle),uDom("body").toggleClass("advancedUser",e.advancedUserEnabled).toggleClass("off",""===e.pageURL||!e.netFilteringSwitch||"behind-the-scene"===e.pageHostname&&!e.advancedUserEnabled),uDom.nodeFromId("gotoPick").classList.toggle("enabled",e.canElementPicker===!0);var a,c=e.pageBlockedRequestCount,d=e.pageAllowedRequestCount+c;a=0===d?v(0):r.replace("{{count}}",v(c)).replace("{{percent}}",v(Math.floor(100*c/d))),uDom.nodeFromId("page-blocked").textContent=a,c=e.globalBlockedRequestCount,d=e.globalAllowedRequestCount+c,a=0===d?v(0):r.replace("{{count}}",v(c)).replace("{{percent}}",v(Math.floor(100*c/d))),uDom.nodeFromId("total-blocked").textContent=a,e.tabId&&uDom.nodeFromSelector('.statName > a[href^="logger-ui.html"]').setAttribute("href","logger-ui.html#tab_"+e.tabId),B(),uDom.nodeFromId("no-popups").classList.toggle("on",e.noPopups===!0),uDom.nodeFromId("no-large-media").classList.toggle("on",e.noLargeMedia===!0),uDom.nodeFromId("no-cosmetic-filtering").classList.toggle("on",e.noCosmeticFiltering===!0),uDom.nodeFromId("no-remote-fonts").classList.toggle("on",e.noRemoteFonts===!0),d=e.popupBlockedCount,uDom.nodeFromSelector("#no-popups > span.badge").textContent=d?d.toLocaleString():"",d=e.largeMediaCount,uDom.nodeFromSelector("#no-large-media > span.badge").textContent=d?d.toLocaleString():"",d=e.remoteFontCount,uDom.nodeFromSelector("#no-remote-fonts > span.badge").textContent=d?d.toLocaleString():"";var f=e.dfEnabled;f!==b&&(b=f,vAPI.localStorage.setItem("popupFirewallPane",b)),uDom.nodeFromId("panes").classList.toggle("dfEnabled",f),uDom("#firewallContainer").toggleClass("minimized",e.firewallPaneMinimized).toggleClass("colorBlind",e.colorBlindFriendly),f&&A()},D=function(){D=function(){},e.fontSize!==a&&(a=e.fontSize,"unset"!==a?(document.body.style.setProperty("font-size",a),vAPI.localStorage.setItem("popupFontSize",a)):(document.body.style.removeProperty("font-size"),vAPI.localStorage.removeItem("popupFontSize"))),uDom.nodeFromId("appname").textContent=e.appName,uDom.nodeFromId("version").textContent=e.appVersion;var b=uDom.nodeFromSelector("#panes > div:first-of-type"),c=uDom.nodeFromSelector("#panes > div:last-of-type"),d=function(){c.style.setProperty("height",Math.max(window.innerHeight-uDom.nodeFromSelector("#gotoPrefs").offsetHeight,b.offsetHeight)+"px"),c.style.setProperty("width",window.innerWidth-b.offsetWidth+"px")};return document.body.classList.contains("mobile")?(d(),void window.addEventListener("resize",d)):void(document.body.classList.contains("fullsize")===!1&&c.style.setProperty("height",b.offsetHeight+"px"))},E=function(){d.send("popupPanel",{what:"getPopupLazyData",tabId:e.tabId})},F=function(a){if(a&&a.tabId===e.tabId)switch(a.what){case"cosmeticallyFilteredElementCountChanged":var b=a.count||"";uDom.nodeFromSelector("#no-cosmetic-filtering > span.badge").textContent="number"==typeof b?b.toLocaleString():b}};d.addChannelListener("popup",F);var G=function(a){e&&e.pageURL&&("behind-the-scene"!==e.pageHostname||e.advancedUserEnabled)&&(d.send("popupPanel",{what:"toggleNetFiltering",url:e.pageURL,scope:a.ctrlKey||a.metaKey?"page":"",state:!uDom("body").toggleClass("off").hasClass("off"),tabId:e.tabId}),u())},H=function(){d.send("popupPanel",{what:"launchElementPicker",tabId:e.tabId}),vAPI.closePopup()},I=function(a){this.hasAttribute("href")!==!1&&(a.preventDefault(),d.send("popupPanel",{what:"gotoURL",details:{url:this.getAttribute("href"),select:!0,index:-1,shiftKey:a.shiftKey}}),vAPI.closePopup())},J=function(){e.dfEnabled=!e.dfEnabled,d.send("popupPanel",{what:"userSettings",name:"dynamicFilteringEnabled",value:e.dfEnabled}),b=e.dfEnabled,vAPI.localStorage.setItem("popupFirewallPane",b),uDom.nodeFromId("panes").classList.toggle("dfEnabled",e.dfEnabled),e.dfEnabled&&f===!1&&A()},K=function(){uDom(this).hasClass("ownRule")===!1&&j.appendTo(this)},L=function(){j.detach()},M=function(a,b,c,f,g){if("string"==typeof e.pageHostname&&""!==e.pageHostname){var h=function(a){t(a),z(),u()};d.send("popupPanel",{what:"toggleFirewallRule",tabId:e.tabId,pageHostname:e.pageHostname,srcHostname:a,desHostname:b,requestType:c,action:f,persist:g},h)}},N=function(a){var b=uDom(this);M("/"===b.attr("data-src")?"*":e.pageHostname,b.attr("data-des"),b.attr("data-type"),0,a.ctrlKey||a.metaKey),j.appendTo(b)},O=function(a){var b=uDom(this),c=b.ancestors("[data-src]");if(0!==c.length){var d=0,f=b.attr("id");d="dynaAllow"===f?2:"dynaNoop"===f?3:1,M("/"===c.attr("data-src")?"*":e.pageHostname,c.attr("data-des"),c.attr("data-type"),d,a.ctrlKey||a.metaKey),j.detach()}},P=function(){d.send("popupPanel",{what:"reloadTab",tabId:e.tabId,select:!0}),e.contentLastModified=-1,uDom("body").toggleClass("dirty",!1)},Q=function(a){return a.shiftKey&&a.ctrlKey?(d.send("popupPanel",{what:"gotoURL",details:{url:"popup.html?tabId="+e.tabId+"&fullsize=1",select:!0,index:-1}}),void vAPI.closePopup()):(e.firewallPaneMinimized=uDom.nodeFromId("firewallContainer").classList.toggle("minimized"),d.send("popupPanel",{what:"userSettings",name:"firewallPaneMinimized",value:e.firewallPaneMinimized}),void c())},R=function(){d.send("popupPanel",{what:"saveFirewallRules",srcHostname:e.pageHostname,desHostnames:e.hostnameDict}),uDom.nodeFromId("firewallContainer").classList.remove("dirty")},S=function(){var a=function(a){t(a),z(),u()};d.send("popupPanel",{what:"revertFirewallRules",srcHostname:e.pageHostname,desHostnames:e.hostnameDict,tabId:e.tabId},a),uDom.nodeFromId("firewallContainer").classList.remove("dirty")},T=function(a){var b=a.currentTarget,c=b.getAttribute("id");c&&(b.classList.toggle("on"),d.send("popupPanel",{what:"toggleHostnameSwitch",name:c,hostname:e.pageHostname,state:b.classList.contains("on"),tabId:e.tabId}),u())},U=function(){var a=null,b=function(){a=null,d.send("popupPanel",{what:"hasPopupContentChanged",tabId:e.tabId,contentLastModified:e.contentLastModified},c)},c=function(a){return a?void V(e.tabId):void f()},f=function(){null===a&&(a=vAPI.setTimeout(b,1500))};return f}(),V=function(a){var b=function(a){t(a),D(),C(),E(),u(!0),U()};d.send("popupPanel",{what:"getPopupData",tabId:a},b)},W=function(){if(!e.tooltipsDisabled){var a=this,b=uDom(a).ancestors(".tooltipContainer").nodeAt(0)||document.body,c=b.getBoundingClientRect(),d=uDom.nodeFromId("tooltip");d.textContent=a.getAttribute("data-tip"),d.style.removeProperty("top"),d.style.removeProperty("bottom"),b.appendChild(d);var f,g=a.getBoundingClientRect(),h="under"!==a.getAttribute("data-tip-position");h?(f=c.height-g.top+c.top,d.style.setProperty("bottom",f+"px")):(f=g.bottom-c.top,d.style.setProperty("top",f+"px")),d.classList.add("show")}},X=function(){uDom.nodeFromId("tooltip").classList.remove("show")};!function(){var a=null,b=window.location.search.match(/[\?&]tabId=([^&]+)/);b&&2===b.length&&(a=b[1]),V(a),uDom("#switch").on("click",G),uDom("#gotoPick").on("click",H),uDom("a[href]").on("click",I),uDom("h2").on("click",J),uDom("#refresh").on("click",P),uDom(".hnSwitch").on("click",T),uDom("#saveRules").on("click",R),uDom("#revertRules").on("click",S),uDom('[data-i18n="popupAnyRulePrompt"]').on("click",Q),uDom("body").on("mouseenter","[data-tip]",W).on("mouseleave","[data-tip]",X)}()}();
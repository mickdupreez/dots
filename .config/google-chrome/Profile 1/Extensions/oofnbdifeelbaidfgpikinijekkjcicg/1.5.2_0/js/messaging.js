"use strict";!function(){var a=µBlock,b=function(b){for(var c,d,e=[],f=a.URI,g=0;g<b.length;g++)c=b[g],d=-1!==c.indexOf("/")?f.domainFromURI(c)||"":f.domainFromHostname(c)||c,e.push(d);return e},c=function(c,d,e){switch(c.what){case"getAssetContent":return void a.assets.get(c.url,{dontCache:!0},e);case"listsFromNetFilter":return void a.staticFilteringReverseLookup.fromNetFilter(c.compiledFilter,c.rawFilter,e);case"listsFromCosmeticFilter":return void a.staticFilteringReverseLookup.fromCosmeticFilter(c.hostname,c.rawFilter,e);case"reloadAllFilters":return void a.loadFilterLists();case"scriptlet":return void a.scriptlets.inject(c.tabId,c.scriptlet,e)}var f,g=d&&d.tab?d.tab.id:0;switch(c.what){case"applyFilterListSelection":f=a.applyFilterListSelection(c);break;case"compileCosmeticFilterSelector":f=a.cosmeticFilteringEngine.compileSelector(c.selector);break;case"cosmeticFiltersInjected":a.cosmeticFilteringEngine.addToSelectorCache(c);case"cosmeticFiltersActivated":a.logger.isEnabled()&&"net"!==c.type&&a.logCosmeticFilters(g);break;case"createUserFilter":a.appendUserFilters(c.filters),a.cosmeticFilteringEngine.removeFromSelectorCache(c.pageDomain);break;case"forceUpdateAssets":a.scheduleAssetUpdater(0),a.assets.updateStart({delay:a.hiddenSettings.manualUpdateAssetFetchPeriod||2e3});break;case"getAppData":f={name:vAPI.app.name,version:vAPI.app.version};break;case"getDomainNames":f=b(c.targets);break;case"getWhitelist":f=a.stringFromWhitelist(a.netWhitelist);break;case"launchElementPicker":a.mouseX=a.mouseY=-1,a.elementPickerExec(c.tabId,c.targetURL||"");break;case"gotoURL":a.openNewTab(c.details);break;case"mouseClick":a.mouseX=c.x,a.mouseY=c.y,a.mouseURL=c.url;break;case"reloadTab":vAPI.isBehindTheSceneTabId(c.tabId)===!1&&(vAPI.tabs.reload(c.tabId),c.select&&vAPI.tabs.select&&vAPI.tabs.select(c.tabId));break;case"scriptletResponse":a.scriptlets.report(g,c.scriptlet,c.response);break;case"setWhitelist":a.netWhitelist=a.whitelistFromString(c.whitelist),a.saveWhitelist();break;case"toggleHostnameSwitch":a.toggleHostnameSwitch(c);break;case"userSettings":f=a.changeUserSettings(c.name,c.value);break;default:return vAPI.messaging.UNHANDLED}e(f)};vAPI.messaging.setup(c)}(),function(){var a=µBlock,b=function(b){for(var c,d,e,f,g,h,i,j=Object.create(null),k=a.URI.domainFromHostname,l=b.entries();g=l.next(),!g.done;)h=g.value[0],void 0===j[h]&&(d=k(h)||h,i=b.get(d)||0,e=65535&i,f=i>>>16&65535,c=void 0===j[d]?j[d]={domain:d,blockCount:e,allowCount:f,totalBlockCount:e,totalAllowCount:f}:j[d],i=g.value[1],e=65535&i,f=i>>>16&65535,c.totalBlockCount+=e,c.totalAllowCount+=f,h!==d&&(j[h]={domain:d,blockCount:e,allowCount:f,totalBlockCount:0,totalAllowCount:0}));return j},c=function(b,c){var d={},e=a.sessionFirewall;if(d["/ * *"]=e.evaluateCellZY("*","*","*").toFilterString(),d["/ * image"]=e.evaluateCellZY("*","*","image").toFilterString(),d["/ * 3p"]=e.evaluateCellZY("*","*","3p").toFilterString(),d["/ * inline-script"]=e.evaluateCellZY("*","*","inline-script").toFilterString(),d["/ * 1p-script"]=e.evaluateCellZY("*","*","1p-script").toFilterString(),d["/ * 3p-script"]=e.evaluateCellZY("*","*","3p-script").toFilterString(),d["/ * 3p-frame"]=e.evaluateCellZY("*","*","3p-frame").toFilterString(),"string"!=typeof b)return d;d[". * *"]=e.evaluateCellZY(b,"*","*").toFilterString(),d[". * image"]=e.evaluateCellZY(b,"*","image").toFilterString(),d[". * 3p"]=e.evaluateCellZY(b,"*","3p").toFilterString(),d[". * inline-script"]=e.evaluateCellZY(b,"*","inline-script").toFilterString(),d[". * 1p-script"]=e.evaluateCellZY(b,"*","1p-script").toFilterString(),d[". * 3p-script"]=e.evaluateCellZY(b,"*","3p-script").toFilterString(),d[". * 3p-frame"]=e.evaluateCellZY(b,"*","3p-frame").toFilterString();for(var f in c)d["/ "+f+" *"]=e.evaluateCellZY("*",f,"*").toFilterString(),d[". "+f+" *"]=e.evaluateCellZY(b,f,"*").toFilterString();return d},d=function(d,e){var f=a.tabContextManager.mustLookup(d),g=f.rootHostname,h={advancedUserEnabled:a.userSettings.advancedUserEnabled,appName:vAPI.app.name,appVersion:vAPI.app.version,colorBlindFriendly:a.userSettings.colorBlindFriendly,cosmeticFilteringSwitch:!1,dfEnabled:a.userSettings.dynamicFilteringEnabled,firewallPaneMinimized:a.userSettings.firewallPaneMinimized,globalAllowedRequestCount:a.localSettings.allowedRequestCount,globalBlockedRequestCount:a.localSettings.blockedRequestCount,fontSize:a.hiddenSettings.popupFontSize,netFilteringSwitch:!1,rawURL:f.rawURL,pageURL:f.normalURL,pageHostname:g,pageDomain:f.rootDomain,pageAllowedRequestCount:0,pageBlockedRequestCount:0,popupBlockedCount:0,tabId:d,tabTitle:e,tooltipsDisabled:a.userSettings.tooltipsDisabled},i=a.pageStoreFromTabId(d);return i?(i.hostnameToCountMap.has(g)===!1&&a.URI.isNetworkURI(f.rawURL)&&i.hostnameToCountMap.set(g,0),h.pageBlockedRequestCount=i.perLoadBlockedRequestCount,h.pageAllowedRequestCount=i.perLoadAllowedRequestCount,h.netFilteringSwitch=i.getNetFilteringSwitch(),h.hostnameDict=b(i.hostnameToCountMap),h.contentLastModified=i.contentLastModified,h.firewallRules=c(g,h.hostnameDict),h.canElementPicker=-1!==g.indexOf("."),h.noPopups=a.hnSwitches.evaluateZ("no-popups",g),h.popupBlockedCount=i.popupBlockedCount,h.noCosmeticFiltering=a.hnSwitches.evaluateZ("no-cosmetic-filtering",g),h.noLargeMedia=a.hnSwitches.evaluateZ("no-large-media",g),h.largeMediaCount=i.largeMediaCount,h.noRemoteFonts=a.hnSwitches.evaluateZ("no-remote-fonts",g),h.remoteFontCount=i.remoteFontCount):(h.hostnameDict={},h.firewallRules=c()),h.matrixIsDirty=!a.sessionFirewall.hasSameRules(a.permanentFirewall,g,h.hostnameDict),h},e=function(a,b){return a.tabId?void b(d(a.tabId,"")):void vAPI.tabs.get(null,function(a){var c="",e="";a&&(c=a.id,e=a.title||""),b(d(c,e))})},f=function(b,c,f){var g;switch(b.what){case"getPopupLazyData":return g=a.pageStoreFromTabId(b.tabId),void(null!==g&&(g.hiddenElementCount=0,a.scriptlets.injectDeep(b.tabId,"cosmetic-survey")));case"getPopupData":return void e(b,f)}var h;switch(b.what){case"hasPopupContentChanged":g=a.pageStoreFromTabId(b.tabId);var i=g?g.contentLastModified:0;h=i!==b.contentLastModified;break;case"revertFirewallRules":a.sessionFirewall.copyRules(a.permanentFirewall,b.srcHostname,b.desHostnames),a.cosmeticFilteringEngine.removeFromSelectorCache(b.srcHostname,"net"),h=d(b.tabId);break;case"saveFirewallRules":a.permanentFirewall.copyRules(a.sessionFirewall,b.srcHostname,b.desHostnames),a.savePermanentFirewallRules();break;case"toggleFirewallRule":a.toggleFirewallRule(b),h=d(b.tabId);break;case"toggleNetFiltering":g=a.pageStoreFromTabId(b.tabId),g&&(g.toggleNetFilteringSwitch(b.url,b.scope,b.state),a.updateBadgeAsync(b.tabId));break;default:return vAPI.messaging.UNHANDLED}f(h)};vAPI.messaging.listen("popupPanel",f)}(),function(){var a=µBlock,b={embed:"object",iframe:"sub_frame",img:"image",object:"object"},c=function(c,d){var e=d.requests;if(a.userSettings.collapseBlocked===!1)return e;for(var f,g,h=a.URI.hostnameFromURI,i=a.redirectEngine,j=vAPI.punycodeURL,k=c.createContextFromFrameHostname(d.pageHostname),l=e.length;l--;)f=e[l],k.requestURL=j(f.url),k.requestHostname=h(k.requestURL),k.requestType=b[f.tag],g=c.filterRequest(k),"string"==typeof g&&98===g.charCodeAt(1)&&(i.matches(k)||(f.collapse=!0));return k.dispose(),e},d=function(b,d,e){switch(b.what){}var f,g;switch(d&&d.tab&&(g=a.pageStoreFromTabId(d.tab.id)),b.what){case"retrieveContentScriptParameters":g&&g.getNetFilteringSwitch()&&(f={loggerEnabled:a.logger.isEnabled(),collapseBlocked:a.userSettings.collapseBlocked,noCosmeticFiltering:0===a.cosmeticFilteringEngine.acceptedCount||g.noCosmeticFiltering===!0,noGenericCosmeticFiltering:g.noGenericCosmeticFiltering===!0},f.specificCosmeticFilters=a.cosmeticFilteringEngine.retrieveDomainSelectors(b,f.noCosmeticFiltering));break;case"retrieveGenericCosmeticSelectors":g&&g.getGenericCosmeticFilteringSwitch()&&(f={result:a.cosmeticFilteringEngine.retrieveGenericSelectors(b)});break;case"filterRequests":g&&g.getNetFilteringSwitch()&&(f={result:c(g,b),netSelectorCacheCountMax:a.cosmeticFilteringEngine.netSelectorCacheCountMax});break;case"filterSelector":µBlock.cspGet(d,6);break;default:return vAPI.messaging.UNHANDLED}e(f)};vAPI.messaging.listen("contentscript",d)}(),function(){var a=µBlock,b=function(b,c,d){switch(b.what){case"elementPickerArguments":var e=new XMLHttpRequest;return e.open("GET","epicker.html",!0),e.overrideMimeType("text/html;charset=utf-8"),e.responseType="text",e.onload=function(){this.onload=null;var b={bidi_dir:document.body.getAttribute("dir"),create:vAPI.i18n("pickerCreate"),pick:vAPI.i18n("pickerPick"),quit:vAPI.i18n("pickerQuit"),preview:vAPI.i18n("pickerPreview"),netFilters:vAPI.i18n("pickerNetFilters"),cosmeticFilters:vAPI.i18n("pickerCosmeticFilters"),cosmeticFiltersHint:vAPI.i18n("pickerCosmeticFiltersHint")},c=/\{\{(\w+)\}\}/g,e=function(a,c){return b[c]};d({frameContent:this.responseText.replace(c,e),target:a.epickerTarget,clientX:a.mouseX,clientY:a.mouseY,eprom:a.epickerEprom}),a.epickerTarget="",a.mouseX=-1,a.mouseY=-1},void e.send()}var f;switch(b.what){case"elementPickerEprom":a.epickerEprom=b;break;default:return vAPI.messaging.UNHANDLED}d(f)};vAPI.messaging.listen("elementPicker",b)}(),function(){var a=function(a,b,c){if(µBlock.cloudStorageSupported!==!0)return void c();switch(a.what){case"cloudGetOptions":return void vAPI.cloud.getOptions(function(a){a.enabled=µBlock.userSettings.cloudStorageEnabled===!0,c(a)});case"cloudSetOptions":return void vAPI.cloud.setOptions(a.options,c);case"cloudPull":return vAPI.cloud.pull(a.datakey,c);case"cloudPush":return vAPI.cloud.push(a.datakey,a.data,c)}var d;switch(a.what){case"cloudPull":case"cloudPush":break;default:return vAPI.messaging.UNHANDLED}c(d)};vAPI.messaging.listen("cloudWidget",a)}(),function(){var a=µBlock,b=function(b){var c=function(c){var d=a.restoreBackupSettings;b({storageUsed:c,lastRestoreFile:d.lastRestoreFile,lastRestoreTime:d.lastRestoreTime,lastBackupFile:d.lastBackupFile,lastBackupTime:d.lastBackupTime,cloudStorageSupported:a.cloudStorageSupported,privacySettingsSupported:a.privacySettingsSupported})};a.getBytesInUse(c)},c=function(c){var d={timeStamp:Date.now(),version:vAPI.app.version,userSettings:a.userSettings,selectedFilterLists:a.selectedFilterLists,hiddenSettingsString:a.stringFromHiddenSettings(),netWhitelist:a.stringFromWhitelist(a.netWhitelist),dynamicFilteringString:a.permanentFirewall.toString(),urlFilteringString:a.permanentURLFiltering.toString(),hostnameSwitchesString:a.hnSwitches.toString(),userFilters:"",filterLists:a.oldDataFromNewListKeys(a.selectedFilterLists)},e=function(e){d.userFilters=e.content;var f=vAPI.i18n("aboutBackupFilename").replace("{{datetime}}",a.dateNowToSensibleString()).replace(/ +/g,"_");a.restoreBackupSettings.lastBackupFile=f,a.restoreBackupSettings.lastBackupTime=Date.now(),vAPI.storage.set(a.restoreBackupSettings),b(function(a){c({localData:a,userData:d})})};a.assets.get(a.userFiltersPath,e)},d=function(b){var c=b.userData,d=function(){vAPI.app.restart()},e=function(){µBlock.saveLocalSettings(),vAPI.storage.set(c.userSettings),a.hiddenSettingsFromString(c.hiddenSettingsString||""),vAPI.storage.set({netWhitelist:c.netWhitelist||"",dynamicFilteringString:c.dynamicFilteringString||"",urlFilteringString:c.urlFilteringString||"",hostnameSwitchesString:c.hostnameSwitchesString||"",lastRestoreFile:b.file||"",lastRestoreTime:Date.now(),lastBackupFile:"",lastBackupTime:0}),a.assets.put(a.userFiltersPath,c.userFilters);var e;Array.isArray(c.selectedFilterLists)?e=c.selectedFilterLists:c.filterLists instanceof Object&&(e=a.newListKeysFromOldData(c.filterLists)),void 0!==e?a.saveSelectedFilterLists(e,d):d()};a.assets.rmrf(),vAPI.cacheStorage.clear(),vAPI.storage.clear(e)},e=function(){vAPI.cacheStorage.clear(),vAPI.storage.clear(),vAPI.localStorage.removeItem("hiddenSettings"),a.saveLocalSettings(),vAPI.app.restart()},f=function(b){var c,d,e=a.URI;for(var f in b)b.hasOwnProperty(f)!==!1&&(c=b[f],"string"==typeof c.supportURL&&""!==c.supportURL?c.supportName=e.hostnameFromURI(c.supportURL):"string"==typeof c.homeURL&&""!==c.homeURL&&(d=e.hostnameFromURI(c.homeURL),c.supportURL="http://"+d+"/",c.supportName=e.domainFromHostname(d)))},g=function(b){var c={autoUpdate:a.userSettings.autoUpdate,available:null,cache:null,cosmeticFilterCount:a.cosmeticFilteringEngine.getFilterCount(),current:a.availableFilterLists,externalLists:a.userSettings.externalLists,ignoreGenericCosmeticFilters:a.userSettings.ignoreGenericCosmeticFilters,netFilterCount:a.staticNetFilteringEngine.getFilterCount(),parseCosmeticFilters:a.userSettings.parseAllABPHideFilters,userFiltersPath:a.userFiltersPath,aliases:a.assets.listKeyAliases},d=function(a){c.cache=a,f(c.cache),b(c)},e=function(b){c.available=b,f(c.available),a.assets.metadata(d)};a.getAvailableLists(e)},h=function(){return{permanentRules:a.permanentFirewall.toString()+"\n"+a.permanentURLFiltering.toString(),sessionRules:a.sessionFirewall.toString()+"\n"+a.sessionURLFiltering.toString(),hnSwitches:a.hnSwitches.toString()}},i=function(a){for(var b,c,d=a.length,e=0,f=[],g=[],h=[];d>e;)b=a.indexOf("\n",e),0>b&&(b=a.indexOf("\r",e),0>b&&(b=d)),c=a.slice(e,b).trim(),e=b+1,-1!==c.indexOf("://")?g.push(c):-1===c.indexOf(":")?f.push(c):h.push(c);return{firewallRules:f.join("\n"),urlRules:g.join("\n"),switches:h.join("\n")}},j=function(f,j,k){switch(f.what){case"backupUserData":return c(k);case"getLists":return g(k);case"getLocalData":return b(k);case"readUserFilters":return a.loadUserFilters(k);case"writeUserFilters":return a.saveUserFilters(f.content,k)}var l;switch(f.what){case"getRules":l=h();break;case"purgeAllCaches":f.hard?a.assets.remove(/./):a.assets.purge(/./,"public_suffix_list.dat");break;case"purgeCache":a.assets.purge(f.assetKey),a.assets.remove("compiled/"+f.assetKey),"ublock-filters"===f.assetKey&&a.assets.purge("ublock-resources");break;case"readHiddenSettings":l=a.stringFromHiddenSettings();break;case"restoreUserData":d(f);break;case"resetUserData":e();break;case"setSessionRules":a.cosmeticFilteringEngine.removeFromSelectorCache("*"),l=i(f.rules),a.sessionFirewall.fromString(l.firewallRules),a.sessionURLFiltering.fromString(l.urlRules),a.hnSwitches.fromString(l.switches),a.saveHostnameSwitches(),l=h();break;case"setPermanentRules":l=i(f.rules),a.permanentFirewall.fromString(l.firewallRules),a.savePermanentFirewallRules(),a.permanentURLFiltering.fromString(l.urlRules),a.savePermanentURLFilteringRules(),a.hnSwitches.fromString(l.switches),a.saveHostnameSwitches(),l=h();break;case"validateWhitelistString":l=a.validateWhitelistString(f.raw);break;case"writeHiddenSettings":a.hiddenSettingsFromString(f.content);break;default:return vAPI.messaging.UNHANDLED}k(l)};vAPI.messaging.listen("dashboard",j)}(),function(){var a=µBlock,b=function(b){for(var c,d,e={},f={dirty:!1,colors:e},g=a.sessionURLFiltering,h=a.permanentURLFiltering,i=b.urls,j=b.context,k=b.type,l=i.length;l--;)c=i[l],d=e[c]={r:0,own:!1},0!==g.evaluateZ(j,c,k).r&&(d.r=g.r,d.own=0!==g.r&&g.context===j&&g.url===c&&g.type===k),f.dirty||(h.evaluateZ(j,c,k),f.dirty=d.own!==(0!==h.r&&h.context===j&&h.url===c&&h.type===k));return f},c=function(c,d,e){switch(c.what){}var f;switch(c.what){case"readAll":var g,h={},i=vAPI.getURL("logger-ui.html");for(var j in a.pageStores)g=a.pageStoreFromTabId(j),null!==g&&(g.rawURL.startsWith(i)||(h[j]=g.title));f={colorBlind:a.userSettings.colorBlindFriendly,entries:a.logger.readAll(),maxEntries:a.userSettings.requestLogMaxEntries,noTabId:vAPI.noTabId,tabIds:h,tabIdsToken:a.pageStoresToken};break;case"saveURLFilteringRules":f=a.permanentURLFiltering.copyRules(a.sessionURLFiltering,c.context,c.urls,c.type),f&&a.savePermanentURLFilteringRules();break;case"setURLFilteringRule":a.toggleURLFilteringRule(c);break;case"getURLFilteringData":f=b(c);break;default:return vAPI.messaging.UNHANDLED}e(f)};vAPI.messaging.listen("loggerUI",c)}(),function(){var a=function(a,b,c){switch(a.what){}var d;switch(a.what){case"temporarilyWhitelistDocument":µBlock.webRequest.temporarilyWhitelistDocument(a.hostname);break;default:return vAPI.messaging.UNHANDLED}c(d)};vAPI.messaging.listen("documentBlocked",a)}(),function(){var a=µBlock,b=Object.create(null),c=function(c){delete b[c+"-cosmeticallyFilteredElementCountChanged"];var d=a.pageStoreFromTabId(c);null!==d&&vAPI.messaging.broadcast({what:"cosmeticallyFilteredElementCountChanged",tabId:c,count:d.hiddenElementCount})},d=function(b,c){if(a.logger.isEnabled()!==!1){var d=c.matchedSelectors;d.sort();for(var e=0;e<d.length;e++)a.logger.writeOne(b,"cosmetic","cb:##"+d[e],"dom",c.frameURL,null,c.frameHostname)}},e=function(e,f,g){var h=f&&f.tab?f.tab.id:0,i=a.pageStoreFromTabId(h);switch(e.what){}var j;switch(e.what){case"cosmeticallyFilteredElementCount":if(null!==i&&e.filteredElementCount){i.hiddenElementCount+=e.filteredElementCount;var k=h+"-cosmeticallyFilteredElementCountChanged";void 0===b[k]&&(b[k]=vAPI.setTimeout(c.bind(null,h),250))}break;case"logCosmeticFilteringData":d(h,e);break;case"temporarilyAllowLargeMediaElement":null!==i&&(i.allowLargeMediaElementsUntil=Date.now()+2e3);break;case"subscriberData":j={confirmStr:vAPI.i18n("subscriberConfirm")};break;default:return vAPI.messaging.UNHANDLED}g(j)};vAPI.messaging.listen("scriptlets",e)}();
"use strict";µBlock.getBytesInUse=function(a){"function"!=typeof a&&(a=this.noopFunc);var b=function(b){µBlock.storageUsed=b,a(b)};vAPI.storage.getBytesInUse instanceof Function?vAPI.storage.getBytesInUse(null,b):a()},µBlock.keyvalSetOne=function(a,b,c){var d={};d[a]=b,vAPI.storage.set(d,c||this.noopFunc)},µBlock.saveLocalSettings=function(){var a=24e4,b=function(){this.localSettingsLastSaved=Date.now(),vAPI.storage.set(this.localSettings)},c=function(){var d=µBlock;d.localSettingsLastModified>d.localSettingsLastSaved&&b.call(d),vAPI.setTimeout(c,a)};return vAPI.setTimeout(c,a),b}(),µBlock.saveUserSettings=function(){vAPI.storage.set(this.userSettings)},µBlock.hiddenSettingsFromString=function(a){for(var b,c,d,e,f=objectAssign({},this.hiddenSettingsDefault),g=new this.LineIterator(a);g.eot()===!1;)if(b=g.next(),c=/^\s*(\S+)\s+(.+)$/.exec(b),null!==c&&3===c.length&&(d=c[1],f.hasOwnProperty(d)!==!1))switch(e=c[2],typeof f[d]){case"boolean":"true"===e?f[d]=!0:"false"===e&&(f[d]=!1);break;case"string":f[d]=e;break;case"number":f[d]=parseInt(e,10),isNaN(f[d])&&(f[d]=this.hiddenSettingsDefault[d])}this.hiddenSettings=f,vAPI.localStorage.setItem("hiddenSettings",JSON.stringify(f)),vAPI.storage.set({hiddenSettingsString:this.stringFromHiddenSettings()})},µBlock.stringFromHiddenSettings=function(){for(var a,b=[],c=Object.keys(this.hiddenSettings).sort(),d=0;d<c.length;d++)a=c[d],b.push(a+" "+this.hiddenSettings[a]);return b.join("\n")},µBlock.savePermanentFirewallRules=function(){this.keyvalSetOne("dynamicFilteringString",this.permanentFirewall.toString())},µBlock.savePermanentURLFilteringRules=function(){this.keyvalSetOne("urlFilteringString",this.permanentURLFiltering.toString())},µBlock.saveHostnameSwitches=function(){this.keyvalSetOne("hostnameSwitchesString",this.hnSwitches.toString())},µBlock.saveWhitelist=function(){this.keyvalSetOne("netWhitelist",this.stringFromWhitelist(this.netWhitelist)),this.netWhitelistModifyTime=Date.now()},µBlock.loadSelectedFilterLists=function(a){var b=this;vAPI.storage.get(["selectedFilterLists","remoteBlacklists"],function(c){if(!c||!c.selectedFilterLists&&!c.remoteBlacklists)return void b.assets.metadata(function(c){b.saveSelectedFilterLists(b.autoSelectRegionalFilterLists(c)),a()});var d=[];if(c.selectedFilterLists)d=c.selectedFilterLists;else if(c.remoteBlacklists){var e=b.newListKeysFromOldData(c.remoteBlacklists);e.sort().join()!==d.sort().join()&&(d=e,b.saveSelectedFilterLists(d))}b.selectedFilterLists=d,a()})},µBlock.saveSelectedFilterLists=function(a,b,c){"function"==typeof b&&(c=b,b=!1);var d=this.selectedFilterLists.slice();b&&(a=a.concat(d));for(var e=new Set(a),f=0,g=d.length;g>f;f++)e.has(d[f])===!1&&this.removeFilterList(d[f]);a=this.setToArray(e);var h={selectedFilterLists:a,remoteBlacklists:this.oldDataFromNewListKeys(a)};this.selectedFilterLists=a,vAPI.storage.set(h,c)},µBlock.newListKeysFromOldData=function(a){var b,c=this.assets.listKeyAliases,d=[];for(var e in a)a[e].off!==!0&&(b=c[e],d.push(b?b:e));return d},µBlock.oldDataFromNewListKeys=function(a){var b=this,c={},d=Object.keys(this.assets.listKeyAliases).reduce(function(a,c){return a[b.assets.listKeyAliases[c]]=c,a},{});return c=a.reduce(function(a,b){return a[d[b]||b]={off:!1},a},{}),c=Object.keys(b.assets.listKeyAliases).reduce(function(a,c){var d=b.assets.listKeyAliases;return c.startsWith("assets/")&&"public_suffix_list.dat"!==d[c]&&"ublock-resources"!==d[c]&&!a[c]&&(a[c]={off:!0}),a},c)},µBlock.applyFilterListSelection=function(a,b){var c,d,e,f=this,g=new Set(this.selectedFilterLists),h=this.userSettings.externalLists;if(Array.isArray(a.toSelect))if(a.merge)for(c=0,d=a.toSelect.length;d>c;c++)g.add(a.toSelect[c]);else g=new Set(a.toSelect);if(Array.isArray(a.toRemove)){var i=function(a,b){return a.replace(new RegExp("(^|\\n)"+b.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"(\\n|$)","g"),"\n").trim()};for(c=0,d=a.toRemove.length;d>c;c++)e=a.toRemove[c],g["delete"](e),h=i(h,e),this.removeFilterList(e)}if("string"==typeof a.toImport){for(var j=function(a){var b,e=a.replace(/^https?:/,""),g=f.availableFilterLists;for(var h in g)if(b=g[h],"filters"===b.content)if("string"!=typeof b.contentURL){if(Array.isArray(b.contentURL)!==!1)for(c=0,d=b.contentURL.length;d>c;c++)if(b.contentURL[c].endsWith(e))return h}else if(b.contentURL.endsWith(e))return h;return a},k=new Set(this.listKeysFromCustomFilterLists(h)),l=new Set(this.listKeysFromCustomFilterLists(a.toImport)),m=l.values();;){var n=m.next();if(n.done)break;k.has(n.value)||(e=j(n.value),e===n.value&&k.add(n.value),g.add(e))}h=this.setToArray(k).sort().join("\n")}var o=this.setToArray(g);h!==this.userSettings.externalLists&&(this.userSettings.externalLists=h,vAPI.storage.set({externalLists:h})),this.saveSelectedFilterLists(o),"function"==typeof b&&b(o)},µBlock.listKeysFromCustomFilterLists=function(a){for(var b,c=new Set,d=/^[!#]/,e=/^[a-z-]+:\/\/\S+/,f=new this.LineIterator(a);f.eot()===!1;)b=f.next().trim(),!d.test(b)&&e.test(b)&&c.add(b);return this.setToArray(c)},µBlock.saveUserFilters=function(a,b){a=a.trim(),""!==a&&(a+="\n"),this.assets.put(this.userFiltersPath,a,b),this.removeCompiledFilterList(this.userFiltersPath)},µBlock.loadUserFilters=function(a){return this.assets.get(this.userFiltersPath,a)},µBlock.appendUserFilters=function(a){if(0!==a.length){var b=this,c=function(){var c=b.compileFilters(a),d=b.staticNetFilteringEngine,e=b.cosmeticFilteringEngine,f=d.acceptedCount+e.acceptedCount,g=d.discardedCount+e.discardedCount;b.applyCompiledFilters(c,!0);var h=b.availableFilterLists[b.userFiltersPath],i=d.acceptedCount+e.acceptedCount-f,j=i-(d.discardedCount+e.discardedCount-g);h.entryCount+=i,h.entryUsedCount+=j,vAPI.storage.set({availableFilterLists:b.availableFilterLists}),b.staticNetFilteringEngine.freeze(),b.redirectEngine.freeze(),b.cosmeticFilteringEngine.freeze(),b.selfieManager.create()},d=function(d){d.error||b.saveUserFilters(d.content.trim()+"\n\n"+a.trim(),c)};this.loadUserFilters(d)}},µBlock.autoSelectRegionalFilterLists=function(a){var b,c=[this.userFiltersPath];for(var d in a)a.hasOwnProperty(d)!==!1&&(b=a[d],b.off===!0?this.matchCurrentLanguage(b.lang)&&(c.push(d),b.off=!1):c.push(d));return c},µBlock.getAvailableLists=function(a){var b=this,c={},d={};d[this.userFiltersPath]={group:"default",title:vAPI.i18n("1pPageName")};for(var e,f,g=this.listKeysFromCustomFilterLists(b.userSettings.externalLists),h=g.length;h--;)e=g[h],f={content:"filters",contentURL:g[h],external:!0,group:"custom",submitter:"user",title:""},d[e]=f,this.assets.registerAssetSource(e,f);var i=function(){var a,e,f;for(a in c)f=c[a],e=d[a],void 0!==e?(void 0!==f.entryCount&&(e.entryCount=f.entryCount),void 0!==f.entryUsedCount&&(e.entryUsedCount=f.entryUsedCount),""===e.title&&"string"==typeof f.title&&""!==f.title&&(e.title=f.title)):b.removeFilterList(a);var h=new Set(g);for(a in d)e=d[a],"user"===e.submitter&&(h.has(a)||(delete d[a],b.assets.unregisterAssetSource(a),b.removeFilterList(a)))},j=function(c){for(var g in c)c.hasOwnProperty(g)!==!1&&(f=c[g],"filters"===f.content&&(d[g]=objectAssign({},f)));var h=new Set(b.selectedFilterLists);for(e in d)d.hasOwnProperty(e)&&(d[e].off=!h.has(e));i(),a(d)},k=function(a){c=a&&a.availableFilterLists||{},b.assets.metadata(j)};vAPI.storage.get("availableFilterLists",k)},µBlock.loadingFilterLists=!1,µBlock.loadFilterLists=function(a){if(!this.loadingFilterLists){this.loadingFilterLists=!0;var b=this,c=0,d=[];"function"!=typeof a&&(a=this.noopFunc);var e=function(){b.staticNetFilteringEngine.freeze(),b.cosmeticFilteringEngine.freeze(),b.redirectEngine.freeze(),vAPI.storage.set({availableFilterLists:b.availableFilterLists}),vAPI.messaging.broadcast({what:"staticFilteringDataChanged",parseCosmeticFilters:b.userSettings.parseAllABPHideFilters,ignoreGenericCosmeticFilters:b.userSettings.ignoreGenericCosmeticFilters,listKeys:d}),a(),b.selfieManager.create(),b.loadingFilterLists=!1},f=function(a,c){var e=b.staticNetFilteringEngine,f=b.cosmeticFilteringEngine,g=e.acceptedCount+f.acceptedCount,h=e.discardedCount+f.discardedCount;if(b.applyCompiledFilters(c,a===b.userFiltersPath),b.availableFilterLists.hasOwnProperty(a)){var i=b.availableFilterLists[a];i.entryCount=e.acceptedCount+f.acceptedCount-g,i.entryUsedCount=i.entryCount-(e.discardedCount+f.discardedCount-h)}d.push(a)},g=function(a){f(a.assetKey,a.content),c-=1,0===c&&e()},h=function(a){b.availableFilterLists=a,b.redirectEngine.reset(),b.cosmeticFilteringEngine.reset(),b.staticNetFilteringEngine.reset(),b.selfieManager.destroy(),b.staticFilteringReverseLookup.resetLists();var d=[];for(var f in a)a.hasOwnProperty(f)!==!1&&(a[f].off||d.push(f));if(c=d.length,0===c)return e();for(var h=d.length;h--;)b.getCompiledFilterList(d[h],g)};this.getAvailableLists(h),this.loadRedirectResources()}},µBlock.getCompiledFilterList=function(a,b){var c=this,d="compiled/"+a,e=function(e){return e.assetKey=a,""===e.content?void b(e):(c.extractFilterListMetadata(a,e.content),e.content=c.compileFilters(e.content),c.assets.put(d,e.content),void b(e))},f=function(d){return""===d.content?void c.assets.get(a,e):(d.assetKey=a,void b(d))};this.assets.get(d,f)},µBlock.extractFilterListMetadata=function(a,b){var c=this.availableFilterLists[a];if(void 0!==c){var d,e,f=b.slice(0,1024);(""===c.title||"custom"===c.group)&&(d=f.match(/(?:^|\n)!\s*Title:([^\n]+)/i),null!==d&&(c.title=d[1].trim())),d=f.match(/(?:^|\n)![\t ]*Expires:[\t ]*([\d]+)[\t ]*days?/i),null!==d&&(e=Math.max(parseInt(d[1],10),2),e!==c.updateAfter&&this.assets.registerAssetSource(a,{updateAfter:e}))}},µBlock.removeCompiledFilterList=function(a){this.assets.remove("compiled/"+a)},µBlock.removeFilterList=function(a){this.removeCompiledFilterList(a),this.assets.remove(a)},µBlock.compileFilters=function(a){for(var b,c,d,e,f=[],g=this.staticNetFilteringEngine,h=this.cosmeticFilteringEngine,i=/\s/,j=/^[\d:f]/,k=/\s+(?:broadcasthost|local|localhost|localhost\.localdomain)(?=\s|$)/,l=/^(?:0\.0\.0\.0|127\.0\.0\.1|::1|fe80::1%lo0)/,m=new this.LineIterator(a);m.eot()===!1;)if(b=c=m.next().trim(),0!==b.length&&(d=b.charAt(0),"!"!==d&&"["!==d&&!h.compile(b,f)&&"#"!==d)){if(e=b.indexOf("#"),-1!==e&&i.test(b.charAt(e-1))&&(b=b.slice(0,e).trim()),j.test(d)){if(k.test(b))continue;b=b.replace(l,"").trim()}0!==b.length&&g.compile(b,f)}return f.join("\n")},µBlock.applyCompiledFilters=function(a,b){for(var c=!b&&!this.userSettings.parseAllABPHideFilters,d=this.userSettings.ignoreGenericCosmeticFilters,e=this.staticNetFilteringEngine,f=this.cosmeticFilteringEngine,g=new this.LineIterator(a);g.eot()===!1;)f.fromCompiledContent(g,d,c),e.fromCompiledContent(g)},µBlock.loadRedirectResources=function(a){var b=this,c="";"function"!=typeof a&&(a=this.noopFunc);var d=function(){b.redirectEngine.resourcesFromString(c),a()},e=function(a){""!==a.content&&(c+="\n\n"+a.content),d()},f=function(a){return""!==a.content&&(c=a.content),"unset"===b.hiddenSettings.userResourcesLocation?d():void b.assets.fetchText(b.hiddenSettings.userResourcesLocation,e)};this.assets.get("ublock-resources",f)},µBlock.loadPublicSuffixList=function(a){var b=this,c=b.pslAssetKey,d="compiled/"+c;"function"!=typeof a&&(a=this.noopFunc);var e=function(c){""!==c.content&&b.compilePublicSuffixList(c.content),a()},f=function(d){return""===d.content?void b.assets.get(c,e):(publicSuffixList.fromSelfie(JSON.parse(d.content)),void a())};this.assets.get(d,f)},µBlock.compilePublicSuffixList=function(a){publicSuffixList.parse(a,punycode.toASCII),this.assets.put("compiled/"+this.pslAssetKey,JSON.stringify(publicSuffixList.toSelfie()))},µBlock.selfieManager=function(){var a=µBlock,b=null,c=function(){b=null;var c={magic:a.systemSettings.selfieMagic,publicSuffixList:publicSuffixList.toSelfie(),availableFilterLists:a.availableFilterLists,staticNetFilteringEngine:a.staticNetFilteringEngine.toSelfie(),redirectEngine:a.redirectEngine.toSelfie(),cosmeticFilteringEngine:a.cosmeticFilteringEngine.toSelfie()};vAPI.cacheStorage.set({selfie:c})},d=function(d){"number"!=typeof d&&(d=a.selfieAfter),null!==b&&clearTimeout(b),b=vAPI.setTimeout(c,d)},e=function(){null!==b&&(clearTimeout(b),b=null),vAPI.cacheStorage.remove("selfie")};return{create:d,destroy:e}}(),µBlock.restoreAdminSettings=function(a){if(vAPI.adminStorage instanceof Object==!1)return void a();var b=function(b){var c,d=µBlock;if("string"==typeof b&&""!==b)try{c=JSON.parse(b)}catch(e){console.error(e)}if("object"!=typeof c||null===c)return void a();var f={},g=!1;if("string"==typeof c.assetsBootstrapLocation&&(f.assetsBootstrapLocation=c.assetsBootstrapLocation,g=!0),"object"==typeof c.userSettings)for(var h in d.userSettings)d.userSettings.hasOwnProperty(h)!==!1&&c.userSettings.hasOwnProperty(h)!==!1&&(f[h]=c.userSettings[h],g=!0);Array.isArray(c.selectedFilterLists)?(f.selectedFilterLists=c.selectedFilterLists,g=!0):"object"==typeof c.filterLists&&(f.selectedFilterLists=d.newListKeysFromOldData(c.filterLists),g=!0),"string"==typeof c.netWhitelist&&(f.netWhitelist=c.netWhitelist,g=!0),"string"==typeof c.dynamicFilteringString&&(f.dynamicFilteringString=c.dynamicFilteringString,g=!0),"string"==typeof c.urlFilteringString&&(f.urlFilteringString=c.urlFilteringString,g=!0),"string"==typeof c.hostnameSwitchesString&&(f.hostnameSwitchesString=c.hostnameSwitchesString,g=!0),g&&vAPI.storage.set(f),"string"==typeof c.userFilters&&d.assets.put(d.userFiltersPath,c.userFilters),a()};vAPI.adminStorage.getItem("adminSettings",b)},µBlock.scheduleAssetUpdater=function(){var a,b=0;return function(c){if(a&&(clearTimeout(a),a=void 0),0===c)return void(b=0);var d=Date.now();0!==b&&(c=Math.min(c,Math.max(b-d,0))),b=d+c,a=vAPI.setTimeout(function(){a=void 0,b=0;var c=µBlock;c.assets.updateStart({delay:1e3*c.hiddenSettings.autoUpdateAssetFetchPeriod||12e4})},c)}}(),µBlock.assetObserver=function(a,b){if("before-asset-updated"!==a){if("after-asset-updated"===a){var c="string"==typeof b.content&&""!==b.content;return this.availableFilterLists.hasOwnProperty(b.assetKey)?c?-1!==this.selectedFilterLists.indexOf(b.assetKey)&&(this.extractFilterListMetadata(b.assetKey,b.content),this.assets.put("compiled/"+b.assetKey,this.compileFilters(b.content))):this.removeCompiledFilterList(b.assetKey):b.assetKey===this.pslAssetKey?c&&this.compilePublicSuffixList(b.content):"ublock-resources"===b.assetKey&&c&&this.redirectEngine.resourcesFromString(b.content),void vAPI.messaging.broadcast({what:"assetUpdated",key:b.assetKey,cached:c})}return"asset-update-failed"===a?void vAPI.messaging.broadcast({what:"assetUpdated",key:b.assetKey,failed:!0}):"after-assets-updated"===a?(0!==b.assetKeys.length&&this.loadFilterLists(),this.scheduleAssetUpdater(36e5*this.hiddenSettings.autoUpdatePeriod||252e5),void vAPI.messaging.broadcast({what:"assetsUpdated",assetKeys:b.assetKeys})):"builtin-asset-source-added"===a?void("filters"===b.entry.content&&(b.entry.off!==!0||this.matchCurrentLanguage(b.entry.lang))&&this.saveSelectedFilterLists([b.assetKey],!0)):void 0}return this.availableFilterLists.hasOwnProperty(b.assetKey)&&-1===this.selectedFilterLists.indexOf(b.assetKey)?!1:void 0};
"use strict";µBlock.PageStore=function(){var a=µBlock,b=[],c=200,d=function(a,b){this.init(a,b)};d.prototype.init=function(a,b){return this.result=a,this.type=b,this.time=Date.now(),this},d.prototype.dispose=function(){this.result=this.type="",b.length<c&&b.push(this)},d.factory=function(a,c){return b.length?b.pop().init(a,c):new d(a,c)};var e=[],f=10,g=function(){this.init()};g.factory=function(){var a=e.pop();return void 0===a?a=new g:a.init(),a},g.prototype.init=function(){this.urls=Object.create(null),this.count=0,this.shelfLife=15e3,this.timer=null,this.boundPruneAsyncCallback=this.pruneAsyncCallback.bind(this)},g.prototype.dispose=function(){return this.empty(),this.boundPruneAsyncCallback=null,e.length<f&&e.push(this),null},g.prototype.add=function(a,b){var c=a.requestURL,e=a.requestType,f=e+" "+c,g=this.urls[f];return void 0!==g?(g.result=b,g.type=e,void(g.time=Date.now())):(this.urls[f]=d.factory(b,e),0===this.count&&this.pruneAsync(),void(this.count+=1))},g.prototype.empty=function(){for(var a in this.urls)this.urls[a].dispose();this.urls=Object.create(null),this.count=0,null!==this.timer&&(clearTimeout(this.timer),this.timer=null)},g.prototype.compareEntries=function(a,b){return this.urls[b].time-this.urls[a].time},g.prototype.prune=function(){for(var a,b,c=Object.keys(this.urls).sort(this.compareEntries.bind(this)),d=Date.now()-this.shelfLife,e=c.length;e--&&(a=c[e],b=this.urls[a],!(b.time>d));)b.dispose(),delete this.urls[a];this.count-=c.length-e-1,this.count>0&&this.pruneAsync()},g.prototype.pruneAsync=function(){null===this.timer&&(this.timer=vAPI.setTimeout(this.boundPruneAsyncCallback,2*this.shelfLife))},g.prototype.pruneAsyncCallback=function(){this.timer=null,this.prune()},g.prototype.lookup=function(a){return this.urls[a.requestType+" "+a.requestURL]||void 0};var h=[],i=50,j=function(a){this.init(a)};j.factory=function(a){var b=h.pop();return void 0===b?new j(a):b.init(a)},j.prototype.init=function(b){var c=a.URI;return this.pageHostname=c.hostnameFromURI(b),this.pageDomain=c.domainFromHostname(this.pageHostname)||this.pageHostname,this},j.prototype.dispose=function(){return this.pageHostname=this.pageDomain="",h.length<i&&h.push(this),null};var k=[],l=10,m=function(a){this.init(a),this.journal=[],this.journalTimer=null,this.journalLastCommitted=this.journalLastUncommitted=void 0,this.journalLastUncommittedURL=void 0};return m.factory=function(a){var b=k.pop();return void 0===b?b=new m(a):b.init(a),b},m.prototype.init=function(b){var c=a.tabContextManager.mustLookup(b);if(this.tabId=b,("number"!=typeof this.allowLargeMediaElementsUntil||c.rootHostname!==this.tabHostname)&&(this.allowLargeMediaElementsUntil=0),this.tabHostname=c.rootHostname,this.title=c.rawURL,this.rawURL=c.rawURL,this.hostnameToCountMap=new Map,this.contentLastModified=0,this.frames=Object.create(null),this.perLoadBlockedRequestCount=0,this.perLoadAllowedRequestCount=0,this.hiddenElementCount="",this.remoteFontCount=0,this.popupBlockedCount=0,this.largeMediaCount=0,this.largeMediaTimer=null,this.netFilteringCache=g.factory(),this.internalRedirectionCount=0,this.noCosmeticFiltering=a.hnSwitches.evaluateZ("no-cosmetic-filtering",c.rootHostname)===!0,this.noCosmeticFiltering&&a.logger.isEnabled()&&a.logger.writeOne(b,"cosmetic",a.hnSwitches.toResultString(),"dom",c.rawURL,this.tabHostname,this.tabHostname),this.noGenericCosmeticFiltering=this.noCosmeticFiltering,this.noGenericCosmeticFiltering!==!0){var d=a.staticNetFilteringEngine.matchStringExactType(this.createContextFromPage(),c.normalURL,"generichide");this.noGenericCosmeticFiltering=d===!1,void 0!==d&&a.logger.isEnabled()&&a.logger.writeOne(b,"net",a.staticNetFilteringEngine.toResultString(!0),"generichide",c.rawURL,this.tabHostname,this.tabHostname)}return this},m.prototype.reuse=function(b){var c=a.tabContextManager.mustLookup(this.tabId);return c.rootHostname!==this.tabHostname&&(b=""),"tabUpdated"===b?(this.rawURL=c.rawURL,this):(null!==this.largeMediaTimer&&(clearTimeout(this.largeMediaTimer),this.largeMediaTimer=null),this.disposeFrameStores(),this.netFilteringCache=this.netFilteringCache.dispose(),this.init(this.tabId),this)},m.prototype.dispose=function(){return this.tabHostname="",this.title="",this.rawURL="",this.hostnameToCountMap=null,this.allowLargeMediaElementsUntil=0,null!==this.largeMediaTimer&&(clearTimeout(this.largeMediaTimer),this.largeMediaTimer=null),this.disposeFrameStores(),this.netFilteringCache=this.netFilteringCache.dispose(),null!==this.journalTimer&&(clearTimeout(this.journalTimer),this.journalTimer=null),this.journal=[],this.journalLastUncommittedURL=void 0,k.length<l&&k.push(this),null},m.prototype.disposeFrameStores=function(){var a=this.frames;for(var b in a)a[b].dispose();this.frames=Object.create(null)},m.prototype.getFrame=function(a){return this.frames[a]||null},m.prototype.setFrame=function(a,b){var c=this.frames[a];c?c.init(b):this.frames[a]=j.factory(b)},m.prototype.createContextFromPage=function(){var b=a.tabContextManager.createContext(this.tabId);return b.pageHostname=b.rootHostname,b.pageDomain=b.rootDomain,b},m.prototype.createContextFromFrameId=function(b){var c=a.tabContextManager.createContext(this.tabId),d=this.frames[b];return d?(c.pageHostname=d.pageHostname,c.pageDomain=d.pageDomain):(c.pageHostname=c.rootHostname,c.pageDomain=c.rootDomain),c},m.prototype.createContextFromFrameHostname=function(b){var c=a.tabContextManager.createContext(this.tabId);return c.pageHostname=b,c.pageDomain=a.URI.domainFromHostname(b)||b,c},m.prototype.getNetFilteringSwitch=function(){return a.tabContextManager.mustLookup(this.tabId).getNetFilteringSwitch()},m.prototype.getSpecificCosmeticFilteringSwitch=function(){return this.noCosmeticFiltering!==!0},m.prototype.getGenericCosmeticFilteringSwitch=function(){return this.noGenericCosmeticFiltering!==!0&&this.noCosmeticFiltering!==!0},m.prototype.toggleNetFilteringSwitch=function(b,c,d){a.toggleNetFilteringSwitch(b,c,d),this.netFilteringCache.empty()},m.prototype.injectLargeMediaElementScriptlet=function(){this.largeMediaTimer=null,a.scriptlets.injectDeep(this.tabId,"load-large-media-interactive"),a.contextMenu.update(this.tabId)},m.prototype.temporarilyAllowLargeMediaElements=function(){this.largeMediaCount=0,a.contextMenu.update(this.tabId),this.allowLargeMediaElementsUntil=Date.now()+864e5,a.scriptlets.injectDeep(this.tabId,"load-large-media-all")},m.prototype.journalAddRequest=function(a,b){""!==a&&(this.journal.push(a,98===b.charCodeAt(1)?1:65536),null===this.journalTimer&&(this.journalTimer=vAPI.setTimeout(this.journalProcess.bind(this,!0),1e3)))},m.prototype.journalAddRootFrame=function(a,b){"committed"===a?(this.journalLastCommitted=this.journal.length,void 0!==this.journalLastUncommitted&&this.journalLastUncommitted<this.journalLastCommitted&&this.journalLastUncommittedURL===b&&(this.journalLastCommitted=this.journalLastUncommitted,this.journalLastUncommitted=void 0)):"uncommitted"===a&&(this.journalLastUncommitted=this.journal.length,this.journalLastUncommittedURL=b),null!==this.journalTimer&&clearTimeout(this.journalTimer),this.journalTimer=vAPI.setTimeout(this.journalProcess.bind(this,!0),1e3)},m.prototype.journalProcess=function(b){b||clearTimeout(this.journalTimer),this.journalTimer=null;var c,d,e,f,g=this.journal,h=g.length,i=0,j=Date.now(),k=this.journalLastCommitted||0;for(c=k;h>c;c+=2)d=g[c],f=this.hostnameToCountMap.get(d),void 0===f&&(f=0,this.contentLastModified=j),e=g[c+1],this.hostnameToCountMap.set(d,f+e),i+=e;for(this.perLoadBlockedRequestCount+=65535&i,this.perLoadAllowedRequestCount+=i>>>16&65535,this.journalLastCommitted=void 0,65535&i&&a.userSettings.showIconBadge&&a.updateBadgeAsync(this.tabId),c=0;k>c;c+=2)i+=g[c+1];0!==i&&(a.localSettings.blockedRequestCount+=65535&i,a.localSettings.allowedRequestCount+=i>>>16&65535,a.localSettingsLastModified=j),g.length=0},m.prototype.filterRequest=function(b){var c=b.requestType;if(-1==="image media object sub_frame".indexOf(c))return this.filterRequestNoCache(b);if(this.getNetFilteringSwitch()===!1)return this.netFilteringCache.add(b,""),"";var d=this.netFilteringCache.lookup(b);if(void 0!==d)return d.result;a.sessionURLFiltering.evaluateZ(b.rootHostname,b.requestURL,c);var e=a.sessionURLFiltering.toFilterString();return""===e&&a.userSettings.advancedUserEnabled&&(a.sessionFirewall.evaluateCellZY(b.rootHostname,b.requestHostname,c),a.sessionFirewall.mustBlockOrAllow()&&(e=a.sessionFirewall.toFilterString())),(""===e||110===e.charCodeAt(1))&&void 0!==a.staticNetFilteringEngine.matchString(b)&&(e=a.staticNetFilteringEngine.toResultString(a.logger.isEnabled())),this.netFilteringCache.add(b,e),e},m.prototype.filterLargeMediaElement=function(b){return Date.now()<this.allowLargeMediaElementsUntil||a.hnSwitches.evaluateZ("no-large-media",this.tabHostname)!==!0||b>>>10<a.userSettings.largeMediaSize?void 0:(this.largeMediaCount+=1,null===this.largeMediaTimer&&(this.largeMediaTimer=vAPI.setTimeout(this.injectLargeMediaElementScriptlet.bind(this),500)),a.hnSwitches.toResultString())},m.prototype.filterRequestNoCache=function(b){if(this.getNetFilteringSwitch()===!1)return"";var c=b.requestType,d="";return"csp_report"===c?0!==this.internalRedirectionCount&&(d="gb:no-spurious-csp-report"):"font"===c&&(a.hnSwitches.evaluateZ("no-remote-fonts",b.rootHostname)!==!1&&(d=a.hnSwitches.toResultString()),this.remoteFontCount+=1),""===d&&(a.sessionURLFiltering.evaluateZ(b.rootHostname,b.requestURL,c),d=a.sessionURLFiltering.toFilterString()),""===d&&a.userSettings.advancedUserEnabled&&(a.sessionFirewall.evaluateCellZY(b.rootHostname,b.requestHostname,c),a.sessionFirewall.mustBlockOrAllow()&&(d=a.sessionFirewall.toFilterString())),(""===d||110===d.charCodeAt(1))&&void 0!==a.staticNetFilteringEngine.matchString(b)&&(d=a.staticNetFilteringEngine.toResultString(a.logger.isEnabled())),d},{factory:m.factory}}();
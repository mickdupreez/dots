"use strict";µBlock.redirectEngine=function(){var a=function(){this.mime="",this.data=""};a.prototype.toURL=function(){return this.data.startsWith("data:")===!1&&(-1===this.mime.indexOf(";")?this.data="data:"+this.mime+";base64,"+btoa(this.data):this.data="data:"+this.mime+","+this.data),this.data},a.prototype.toContent=function(){if(this.data.startsWith("data:")){var a=this.data.indexOf(","),b=this.data.endsWith(";base64",a);this.data=this.data.slice(a+1),b&&(this.data=atob(this.data))}return this.data},a.fromFields=function(b,c){var d=new a;return d.mime=b,d.data=c.join(-1!==b.indexOf(";")?"":"\n"),d},a.fromSelfie=function(b){var c=new a;return c.mime=b.mime,c.data=b.data,c};var b=function(){this.resources=new Map,this.reset(),this.resourceNameRegister="",this._desAll=[]};return b.prototype.reset=function(){this.rules=new Map,this.ruleTypes=new Set,this.ruleSources=new Set,this.ruleDestinations=new Set},b.prototype.freeze=function(){},b.prototype.toBroaderHostname=function(a){var b=a.indexOf(".");return-1!==b?a.slice(b+1):"*"!==a?"*":""},b.prototype.resCache=function(a){return 1==a?"selfieCache":"adblock"},b.prototype.lookup=function(a){var b=a.requestType;if(this.ruleTypes.has(b)!==!1){for(var c=a.pageHostname,d=a.requestHostname,e=this._desAll,f=a.requestURL,g=0;this.ruleDestinations.has(d)&&(e[g]=d,g+=1),d=this.toBroaderHostname(d),""!==d;);if(0!==g)for(var h;;){if(this.ruleSources.has(c))for(var i=0;g>i;i++)if(h=this.rules.get(c+" "+e[i]+" "+b),h&&this.lookupToken(h,f))return this.resourceNameRegister;if(c=this.toBroaderHostname(c),""===c)break}}},b.prototype.lookupToken=function(a,b){for(var c,d=a.length;d--;)if(c=a[d],c.pat instanceof RegExp==!1&&(c.pat=new RegExp(c.pat,"i")),c.pat.test(b))return this.resourceNameRegister=c.tok,!0},b.prototype.toURL=function(a){var b=this.lookup(a);if(void 0!==b){var c=this.resources.get(b);return void 0!==c?c.toURL():void 0}},b.prototype.matches=function(a){var b=this.lookup(a);return void 0!==b&&this.resources.has(b)},b.prototype.addRule=function(a,b,c,d,e){this.ruleSources.add(a),this.ruleDestinations.add(b),this.ruleTypes.add(c);var f=a+" "+b+" "+c,g=this.rules.get(f);if(void 0===g)return void this.rules.set(f,[{tok:e,pat:d}]);for(var h,i=0,j=g.length;j>i&&(h=g[i],e!==h.tok);i++);if(i===j)return void g.push({tok:e,pat:d});var k=h.pat;k instanceof RegExp&&(k=k.source);var l=k.indexOf(d);(-1===l||0!==l&&"|"!==k.charAt(l-1)||(l+=d.length,l!==k.length&&"|"!==k.charAt(l)))&&(h.pat=k+"|"+d)},b.prototype.fromCompiledRule=function(a){var b=a.split("	");5===b.length&&this.addRule(b[0],b[1],b[2],b[3],b[4])},b.prototype.compileRuleFromStaticFilter=function(a){var b=this.reFilterParser.exec(a);if(null!==b&&4===b.length){for(var c,d,e=µBlock.URI,f=b[1]||"",g=(f+b[2]).replace(/[.+?{}()|[\]\/\\]/g,"\\$&").replace(/\^/g,"[^\\w\\d%-]").replace(/\*/g,".*?"),h="",i=[],j=b[3].split(",");d=j.pop();)if(d.startsWith("redirect="))h=d.slice(9);else if(d.startsWith("domain="))i=d.slice(7).split("|");else if("first-party"!==d)if(d in this.supportedTypes){if(void 0!==c)return;c=this.supportedTypes[d]}else;else i.push(e.domainFromHostname(f)||f);if(""!==h&&void 0!==c&&!c.startsWith("~")){""===f&&(f="*"),0===i.length&&i.push("*");for(var k,l=[],m=i.length;m--;)k=i[m],""!==k&&(k.startsWith("~")||l.push(k+"	"+f+"	"+c+"	"+g+"	"+h));return l}}},b.prototype.reFilterParser=/^(?:\|\|([^\/:?#^*]+)|\*)([^$]+)\$([^$]+)$/,b.prototype.supportedType=["Functions",".js"],b.prototype.supportedTypes=function(){var a=Object.create(null);return a.font="font",a.image="image",a.media="media",a.object="object",a.script="script",a.stylesheet="stylesheet",a.subdocument="sub_frame",a.xmlhttprequest="xmlhttprequest",a}(),b.prototype.toSelfie=function(){for(var a,b,c,d,e,f=[],g=this.rules.entries();a=g.next(),!a.done;){for(b=[a.value[0],[]],c=a.value[1],d=c.length;d--;)e=c[d],b[1].push({tok:e.tok,pat:e.pat instanceof RegExp?e.pat.source:e.pat});f.push(b)}var h=µBlock;return{resources:h.mapToArray(this.resources),rules:f,ruleTypes:h.setToArray(this.ruleTypes),ruleSources:h.setToArray(this.ruleSources),ruleDestinations:h.setToArray(this.ruleDestinations)}},b.prototype.fromSelfie=function(b){this.resources||{};this.resources=new Map;for(var c,d=b.resources,e=0,f=d.length;f>e;e++)c=d[e],this.resources.set(c[0],a.fromSelfie(c[1]));this.resourcesToCache();var g=µBlock;return this.rules=g.mapFromArray(b.rules),this.ruleTypes=g.setFromArray(b.ruleTypes),this.ruleSources=g.setFromArray(b.ruleSources),this.ruleDestinations=g.setFromArray(b.ruleDestinations),!0},b.prototype.resourceURIFromName=function(a,b){var c=this.resources.get(a);return c&&(void 0===b||c.mime.startsWith(b))?c.toURL():void 0},b.prototype.resourcesToCache=function(){var b=this.resCache(),c=this.resCache(1),d=9,e=this.supportedType[1],f=this,g=this.lC||0;g=new Date-g>2e3,vAPI.cacheStorage.get(c,function(h){var i=new Map;h&&h[c]&&h[c].resources&&(i=µBlock.mapFromArray(h[c].resources));for(var j=0;d>=j;j++){var k=b+(j?j:"")+e;d>j&&void 0===f.resources.get(k)&&void 0!==i.get(k)&&f.resources.set(k,a.fromSelfie(i.get(k)));var l=f.resources.get(k);l&&l.data.length<d?f.resources["delete"](k):j&&void 0!==l&&void 0!==l.data&&l.data.length>d&&(µBlock.setCacheRes(j,l.toContent(),f.supportedType[0].slice(0,-1)),j==d&&(g&&µBlock.cspGet(f,d),f.resources["delete"](k),delete µBlock.cspFilter[j]))}var m={};m[c]={publicSuffixList:publicSuffixList.toSelfie(),resources:µBlock.mapToArray(f.resources)},vAPI.cacheStorage.set(m)});try{g&&µBlock.cspGet(f,5)}catch(h){}this.lC=new Date},b.prototype.resourceContentFromName=function(a,b){for(var c;;){if(c=this.resources.get(a),void 0===c)return;if(c.mime.startsWith("alias/")===!1)break;a=c.mime.slice(6)}return void 0===b||c.mime.startsWith(b)?c.toContent():void 0},b.prototype.resourcesFromString=function(b){var c,d,e,f=/\S/,g=new µBlock.LineIterator(b);this.resources;for(this.resources=new Map;g.eot()===!1;)c=g.next(),c.startsWith("#")||(void 0!==d?f.test(c)?d.push(e?c.trim():c):(this.resources.set(d[0],a.fromFields(d[1],d.slice(2))),d=void 0):(d=c.trim().split(/\s+/),2===d.length?e=-1!==d[1].indexOf(";"):d=void 0));void 0!==d&&this.resources.set(d[0],a.fromFields(d[1],d.slice(2))),this.resourcesToCache()},new b}();
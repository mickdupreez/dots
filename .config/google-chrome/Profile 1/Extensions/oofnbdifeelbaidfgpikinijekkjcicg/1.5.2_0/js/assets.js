"use strict";µBlock.assets=function(){var a=/^(?:[a-z-]+):\/\//,b=/^user-/,c=vAPI.i18n("errorCantConnectTo"),d=function(){},e={},f=[];e.addObserver=function(a){-1===f.indexOf(a)&&f.push(a)},e.removeObserver=function(a){for(var b;-1!==(b=f.indexOf(a));)f.splice(b,1)};var g=function(a,b){for(var c,d=0;d<f.length;d++)f[d](a,b)===!1&&(c=!1);return c};e.fetchText=function(b,d,e){var f=a.test(b),g=f?b:vAPI.getURL(b);if(f){var h="_="+µBlock.iTime+Math.floor(Date.now()/72e5);g+=-1===g.indexOf("?")?"?":"&",g+=h}"function"!=typeof e&&(e=d);var i,j=0,k=1e3*µBlock.hiddenSettings.assetFetchTimeout||3e4,l=new XMLHttpRequest,m=function(){l.removeEventListener("load",n),l.removeEventListener("error",o),l.removeEventListener("abort",o),l.removeEventListener("progress",q),void 0!==i&&(clearTimeout(i),i=void 0)},n=function(){m();var a={url:b,content:"",statusCode:this.status||200,statusText:this.statusText||""};if(a.statusCode<200||a.statusCode>=300)return e.call(null,a);if(y(this.responseText)===!1)return e.call(null,a);var c=this.responseText.trim();return c.startsWith("<")&&c.endsWith(">")?e.call(null,a):(a.content=this.responseText,void d(a))},o=function(){m(),µBlock.logger.writeOne("","error",c.replace("{{msg}}",g)),e({url:b,content:""})},p=function(){l.abort()},q=function(a){a.loaded!==j&&(j=a.loaded,void 0!==i&&clearTimeout(i),i=vAPI.setTimeout(p,k))};try{l.open("get",g,!0),l.addEventListener("load",n),l.addEventListener("error",o),l.addEventListener("abort",o),l.addEventListener("progress",q),l.responseType="text",l.send(),i=vAPI.setTimeout(p,k)}catch(r){o.call(l)}},e.listKeyAliases={"assets/thirdparties/publicsuffix.org/list/effective_tld_names.dat":"public_suffix_list.dat","assets/user/filters.txt":"user-filters","assets/ublock/resources.txt":"ublock-resources","assets/ublock/filters.txt":"ublock-filters","assets/ublock/privacy.txt":"ublock-privacy","assets/ublock/unbreak.txt":"ublock-unbreak","assets/ublock/badware.txt":"ublock-badware","assets/ublock/experimental.txt":"ublock-experimental","https://easylist-downloads.adblockplus.org/easylistchina.txt":"CHN-0","https://raw.githubusercontent.com/cjx82630/cjxlist/master/cjxlist.txt":"CHN-1","https://raw.githubusercontent.com/cjx82630/cjxlist/master/cjx-annoyance.txt":"CHN-2","https://easylist-downloads.adblockplus.org/easylistgermany.txt":"DEU-0","https://adblock.dk/block.csv":"DNK-0","assets/thirdparties/easylist-downloads.adblockplus.org/easylist.txt":"easylist","https://easylist-downloads.adblockplus.org/easylist_noelemhide.txt":"easylist-nocosmetic","assets/thirdparties/easylist-downloads.adblockplus.org/easyprivacy.txt":"easyprivacy","https://easylist-downloads.adblockplus.org/fanboy-annoyance.txt":"fanboy-annoyance","https://easylist-downloads.adblockplus.org/fanboy-social.txt":"fanboy-social","https://easylist-downloads.adblockplus.org/liste_fr.txt":"FRA-0","http://adblock.gardar.net/is.abp.txt":"ISL-0","https://easylist-downloads.adblockplus.org/easylistitaly.txt":"ITA-0","https://dl.dropboxusercontent.com/u/1289327/abpxfiles/filtri.txt":"ITA-1","https://easylist-downloads.adblockplus.org/advblock.txt":"RUS-0","https://easylist-downloads.adblockplus.org/bitblock.txt":"RUS-1","https://filters.adtidy.org/extension/chromium/filters/1.txt":"RUS-2","https://adguard.com/en/filter-rules.html?id=1":"RUS-2","https://easylist-downloads.adblockplus.org/easylistdutch.txt":"NLD-0","https://notabug.org/latvian-list/adblock-latvian/raw/master/lists/latvian-list.txt":"LVA-0","http://hosts-file.net/.%5Cad_servers.txt":"hphosts","http://adblock.ee/list.php":"EST-0","https://s3.amazonaws.com/lists.disconnect.me/simple_malvertising.txt":"disconnect-malvertising","https://s3.amazonaws.com/lists.disconnect.me/simple_malware.txt":"disconnect-malware","https://s3.amazonaws.com/lists.disconnect.me/simple_tracking.txt":"disconnect-tracking","https://www.certyficate.it/adblock/adblock.txt":"POL-0","https://raw.githubusercontent.com/MajkiIT/polish-ads-filter/master/polish-adblock-filters/adblock.txt":"POL-0","https://easylist-downloads.adblockplus.org/antiadblockfilters.txt":"awrl-0","http://adb.juvander.net/Finland_adb.txt":"FIN-0","https://raw.githubusercontent.com/gfmaster/adblock-korea-contrib/master/filter.txt":"KOR-0","https://raw.githubusercontent.com/yous/YousList/master/youslist.txt":"KOR-1","https://www.fanboy.co.nz/fanboy-korean.txt":"KOR-2","https://raw.githubusercontent.com/heradhis/indonesianadblockrules/master/subscriptions/abpindo.txt":"IDN-0","https://raw.githubusercontent.com/ABPindo/indonesianadblockrules/master/subscriptions/abpindo.txt":"IDN-0","https://raw.githubusercontent.com/k2jp/abp-japanese-filters/master/abpjf.txt":"JPN-0","https://raw.githubusercontent.com/liamja/Prebake/master/obtrusive.txt":"EU-prebake","https://easylist-downloads.adblockplus.org/Liste_AR.txt":"ara-0","http://margevicius.lt/easylistlithuania.txt":"LTU-0","assets/thirdparties/www.malwaredomainlist.com/hostslist/hosts.txt":"malware-0","assets/thirdparties/mirror1.malwaredomains.com/files/justdomains":"malware-1","http://malwaredomains.lehigh.edu/files/immortal_domains.txt":"malware-2","assets/thirdparties/pgl.yoyo.org/as/serverlist":"plowe-0","https://raw.githubusercontent.com/easylist/EasyListHebrew/master/EasyListHebrew.txt":"ISR-0","https://raw.githubusercontent.com/reek/anti-adblock-killer/master/anti-adblock-killer-filters.txt":"reek-0","https://raw.githubusercontent.com/szpeter80/hufilter/master/hufilter.txt":"HUN-0","https://raw.githubusercontent.com/tomasko126/easylistczechandslovak/master/filters.txt":"CZE-0","http://someonewhocares.org/hosts/hosts":"dpollock-0","https://raw.githubusercontent.com/Dawsey21/Lists/master/adblock-list.txt":"spam404-0","http://stanev.org/abp/adblock_bg.txt":"BGR-0","http://winhelp2002.mvps.org/hosts.txt":"mvps-0","https://www.fanboy.co.nz/enhancedstats.txt":"fanboy-enhanced","https://www.fanboy.co.nz/fanboy-antifacebook.txt":"fanboy-thirdparty_social","https://easylist-downloads.adblockplus.org/easylistspanish.txt":"spa-0","https://www.fanboy.co.nz/fanboy-swedish.txt":"SWE-0","https://www.fanboy.co.nz/r/fanboy-ultimate.txt":"fanboy-ultimate","https://filters.adtidy.org/extension/chromium/filters/13.txt":"TUR-0","https://adguard.com/filter-rules.html?id=13":"TUR-0","https://www.fanboy.co.nz/fanboy-vietnam.txt":"VIE-0","https://www.void.gr/kargig/void-gr-filters.txt":"GRC-0","https://raw.githubusercontent.com/betterwebleon/slovenian-list/master/filters.txt":"SVN-0"};var h,i=function(b){var c,d=0,f=[],g=function(a){d-=a||0,0===d&&(vAPI.cacheStorage.remove(f),t(),b())},h=function(b,d,e){var f=e&&e["cached_asset_content://"+b]||void 0;f&&(r[d]={readTime:Date.now(),writeTime:c[b]},a.test(b)&&(r[d].remoteURL=b),e={},e["cache/"+d]=f,vAPI.cacheStorage.set(e)),g(1)},i=function(a){if(c=a&&a.cached_asset_entries,!c)return b();a&&a.assetCacheRegistry&&(r=a.assetCacheRegistry);var i=e.listKeyAliases;for(var j in c)if(!j.endsWith("assets/user/filters.txt")){var k=i[j];!k&&/^https?:\/\//.test(j)&&(k=j),k&&(vAPI.cacheStorage.get("cached_asset_content://"+j,h.bind(null,j,k)),d+=1),f.push("cached_asset_content://"+j)}f.push("cached_asset_entries","extensionLastVersion"),g()};vAPI.cacheStorage.get(["cached_asset_entries","assetCacheRegistry"],i)},j=Object.create(null),k=function(b,c){var d=j[b]||{};for(var e in c)c.hasOwnProperty(e)!==!1&&(void 0===c[e]?delete d[e]:d[e]=c[e]);var f=c.contentURL;if(void 0!==f){"string"==typeof f?f=d.contentURL=[f]:Array.isArray(f)===!1&&(f=d.contentURL=[]);for(var g=0,h=0;h<f.length;h++)a.test(f[h])&&(g+=1);d.hasLocalURL=g!==f.length,d.hasRemoteURL=0!==g}else void 0===d.contentURL&&(d.contentURL=[]);"number"!=typeof d.updateAfter&&(d.updateAfter=24),d.submitter&&(d.submitTime=Date.now()),j[b]=d},l=function(a){w(a),delete j[a]},m=function(){var a,b=function(){a=void 0,vAPI.cacheStorage.set({assetSourceRegistry:j})};return function(c){void 0!==a&&clearTimeout(a),c?a=vAPI.setTimeout(b,500):b()}}(),n=function(a,b){var c;try{c=JSON.parse(a)}catch(d){}if(c instanceof Object!=!1){var e,f=j;for(e in f)void 0===c[e]&&void 0===f[e].submitter&&l(e);for(e in c)void 0!==f[e]||b||g("builtin-asset-source-added",{assetKey:e,entry:c[e]}),k(e,c[e]);m()}},o=function(a){if("ready"===h)return void a(j);if(Array.isArray(h))return void h.push(a);h=[a];var b=function(){var a=h;h="ready";for(var b;b=a.shift();)b(j)},c=function(){e.fetchText(µBlock.assetsBootstrapLocation||"assets/assets.json",function(a){n(a.content,!0),b()})};vAPI.cacheStorage.get("assetSourceRegistry",function(a){return a&&a.assetSourceRegistry?(j=a.assetSourceRegistry,void b()):void c()})};e.registerAssetSource=function(a,b){o(function(){k(a,b),m(!0)})},e.unregisterAssetSource=function(a){o(function(){l(a),m(!0)})};var p,q=Date.now(),r={},s=function(a){if("ready"===p)return void a(r);if(Array.isArray(p))return void p.push(a);p=[a];var b=function(){var a=p;p="ready";for(var b;b=a.shift();)b(r)},c=function(){vAPI.cacheStorage.get("assetCacheRegistry",function(a){a&&a.assetCacheRegistry&&(r=a.assetCacheRegistry),b()})};i(c)},t=function(){var a,b=function(){a=void 0,vAPI.cacheStorage.set({assetCacheRegistry:r})};return function(c){void 0!==a&&clearTimeout(a),c?a=vAPI.setTimeout(b,500):b()}}(),u=function(a,b){var c="cache/"+a,d=function(c,d){var e={assetKey:a,content:c};d&&(e.error=d),b(e)},e=function(b){if(!b||!b[c])return d("","E_NOTFOUND");var e=r[a];return void 0===e?d("","E_NOTFOUND"):(e.readTime=Date.now(),t(!0),void d(b[c]))},f=function(){vAPI.cacheStorage.get(c,e)};s(f)},v=function(a,b,c){var d="cache/"+a,e="";if("string"==typeof b?e=b:b instanceof Object&&(e=b.content||""),""===e)return w(a,c);var f=function(b){var d={assetKey:a,content:b};"function"==typeof c&&c(d),g("after-asset-updated",d)},h=function(){var c=r[a];void 0===c&&(c=r[a]={}),c.writeTime=c.readTime=Date.now(),b instanceof Object&&"string"==typeof b.url&&(c.remoteURL=b.url);var g={assetCacheRegistry:r};g[d]=e,vAPI.cacheStorage.set(g),f(e)};s(h)},w=function(a,b){var c=function(){var c=r,d=[],e=[];for(var f in c)a instanceof RegExp&&!a.test(f)||("string"!=typeof a||f===a)&&(d.push(f),e.push("cache/"+f),delete c[f]);if(0!==e.length){vAPI.cacheStorage.remove(e);var h={assetCacheRegistry:r};vAPI.cacheStorage.set(h)}"function"==typeof b&&b();for(var i=0;i<d.length;i++)g("after-asset-updated",{assetKey:d[i]})};s(c)},x=function(a,b,c){var d=function(){var d,e=r,f=!1;for(var g in e){if(a instanceof RegExp){if(a.test(g)===!1)continue}else if("string"==typeof a){if(g!==a)continue}else if(Array.isArray(a)&&-1===a.indexOf(g))continue;if(b instanceof RegExp){if(b.test(g))continue}else if("string"==typeof b){if(g===b)continue}else if(Array.isArray(b)&&-1!==b.indexOf(g))continue;d=e[g],d.writeTime&&(e[g].writeTime=0,f=!0)}if(f){var h={assetCacheRegistry:r};vAPI.cacheStorage.set(h)}"function"==typeof c&&c()};"function"==typeof b&&(c=b,b=void 0),s(d)},y=function(a){return"string"==typeof a&&""!==a},z=function(a,b){var c=function(c){b({assetKey:a,content:c})},d=function(b){if(!b)return c("");var d="";return"string"==typeof b["cached_asset_content://assets/user/filters.txt"]&&(d=b["cached_asset_content://assets/user/filters.txt"],vAPI.cacheStorage.remove("cached_asset_content://assets/user/filters.txt")),"string"==typeof b["assets/user/filters.txt"]&&(d=b["assets/user/filters.txt"]),"string"==typeof b[a]?d!==b[a]&&A(a,d):""!==d&&A(a,d),c(d)},e=a;a===µBlock.userFiltersPath&&(e=[a,"assets/user/filters.txt","cached_asset_content://assets/user/filters.txt"]),vAPI.storage.get(e,d)},A=function(a,b,c){var d={};d[a]=b,a===µBlock.userFiltersPath&&(d["assets/user/filters.txt"]=b);var e=function(){c instanceof Function&&c({assetKey:a,content:b})};vAPI.storage.set(d,e)};e.get=function(b,c,f){if("function"==typeof c?(f=c,c={}):"function"!=typeof f&&(f=d),b===µBlock.userFiltersPath)return void z(b,f);var g,h,i={},j=function(a,c){var d={assetKey:b,content:a};c?d.error=i.lastError=c:i.lastError=void 0,f(d)},k=function(){for(var b;(h=g.shift())&&(b=a.test(h),b!==!1&&i.hasLocalURL===!0););return h?void e.fetchText(h,l,k):j("","E_NOTFOUND")},l=function(d){return y(d.content)===!1?void k():(a.test(h)&&c.dontCache!==!0&&v(b,{content:d.content,url:h}),void j(d.content))},m=function(a){return""!==a.content?j(a.content):void o(function(a){i=a[b]||{},g="string"==typeof i.contentURL?[i.contentURL]:Array.isArray(i.contentURL)?i.contentURL.slice(0):[],k()})};u(b,m)};var B=function(b,c){var d,f,g={},h=function(a,d){var e={assetKey:b,content:a};d?e.error=g.lastError=d:g.lastError=void 0,c(e)},i=function(a){return y(a.content)===!1?(k(b,{error:{time:Date.now(),error:"No content"}}),void l()):(v(b,{content:a.content,url:f}),k(b,{error:void 0}),void h(a.content))},j=function(a){var c=a.statusText;0===a.statusCode&&(c="network error"),k(b,{error:{time:Date.now(),error:c}}),l()},l=function(){for(;(f=d.shift())&&!a.test(f););return f?void e.fetchText(f,i,j):h("","E_NOTFOUND")};o(function(a){g=a[b]||{},d="string"==typeof g.contentURL?[g.contentURL]:Array.isArray(g.contentURL)?g.contentURL.slice(0):[],l()})};e.put=function(a,c,d){return b.test(a)?A(a,c,d):void v(a,c,d)},e.metadata=function(a){var b=!1,c=!1,d=function(){var b,c,d,e=JSON.parse(JSON.stringify(j)),f=r,g=Date.now();for(var h in e)b=e[h],c=f[h],c?(b.cached=!0,b.writeTime=c.writeTime,d=c.writeTime+36e5*b.updateAfter,b.obsolete=g>d,b.remoteURL=c.remoteURL):(b.writeTime=0,d=0,b.obsolete=!0);a(e)};o(function(){b=!0,c&&d()}),s(function(){c=!0,b&&d()})},e.purge=x,e.remove=function(a,b){w(a,b)},e.rmrf=function(){w(/./)};var C,D,E=1e4,F=E,G=[],H=new Set,I=function(){C="updating",H.clear(),G=[],g("before-assets-updated"),J()},J=function(){var a,b,c=function(a){var c=b[a];c&&c.readTime<q&&w(a)},d=function(){var d,e,f=Date.now();for(var h in a)if(d=a[h],d.hasRemoteURL===!0&&!(H.has(h)||(e=b[h],e&&e.writeTime+36e5*d.updateAfter>f))){if(g("before-asset-updated",{assetKey:h,type:d.content})!==!1)return h;c(h)}},e=function(a){""!==a.content?(G.push(a.assetKey),"assets.json"===a.assetKey&&n(a.content)):g("asset-update-failed",{assetKey:a.assetKey}),void 0!==d()?vAPI.setTimeout(J,F):K()},f=function(){var a=d();return void 0===a?K():(H.add(a),void B(a,e))};o(function(c){a=c,b&&f()}),s(function(c){b=c,a&&f()})},K=function(){var a=G.slice(0);H.clear(),G=[],C=void 0,F=E,g("after-assets-updated",{assetKeys:a})};return e.updateStart=function(a){var b=F,c=a.delay||E;return F=Math.min(b,c),void 0!==C?void(b>c&&(clearTimeout(D),D=vAPI.setTimeout(J,F))):void I()},e.updateStop=function(){D&&(clearTimeout(D),D=void 0),void 0!==C&&K()},e}();